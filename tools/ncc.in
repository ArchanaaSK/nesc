#!@pathperl@
# -*- perl -*-

# This file is part of the nesC compiler.
# 
# This file is derived from the RC Compiler. It is thus
#    Copyright (C) 2000-2001 The Regents of the University of California.
# Changes for nesC are
#    Copyright (C) 2002 Intel Corporation
# 
# The attached "nesC" software is provided to you under the terms and
# conditions of the GNU General Public License Version 2 as published by the
# Free Software Foundation.
# 
# nesC is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with nesC; see the file COPYING.  If not, write to
# the Free Software Foundation, 59 Temple Place - Suite 330,
# Boston, MA 02111-1307, USA.

# Configuration
$cygwin = "@CYGWINHACKS@";
$prefix = "@prefix@";
$exec_prefix = "@exec_prefix@";
$TOSDIR = "@TOSDIR@";
$TOSDIR = $ENV{"TOSDIR"} if defined($ENV{"TOSDIR"});

# Have fun with the arguments

for ($i = 0; $i <= $#ARGV; $i++) {
    $strip = 0;
    $_ = $ARGV[$i];
    if (/^-/) {
	if (/^-target=(.*)/) {
	    &fail("multiple targets specified") if defined($target);
	    $target = $1;
	    $strip = 1;
	}
	elsif (/^-tosdir=(.*)/) {
	    $TOSDIR = $1;
	    $strip = 1;
	}
	elsif (/^-nostdinc$/) {
	    $nostdinc = 1;
	}
	elsif (/^-board=(.*)/) {
	    push @boards, $1;
	    $strip = 1;
	}
	elsif (/^-print-tosdir$/) {
	    $print_tosdir = 1;
	    $strip = 1;
	}
	elsif (/^-g$/) {
	    $debugging = 1;
	}
	elsif (/^-v$/) {
	    $verbose = 1;
	}
    } 

    push @new_args, $_ if !$strip;
}

if ($print_tosdir)
{
    print $TOSDIR, "\n";
    exit 0;
}

$target = "mica" if !defined($target);

$platform_def = "$TOSDIR/platform/$target/.platform";
if (!-f $platform_def) {
    print STDERR "Unknown target $target\n";
    print STDERR "Known targets for TinyOS directory $TOSDIR are:\n";
    if (opendir PLATFORMS, "$TOSDIR/platform") {
	foreach $d (readdir PLATFORMS) {
	    push @platforms, $d if (-f "$TOSDIR/platform/$d/.platform");
	}
	closedir PLATFORMS;
    }
    if (@platforms) {
	print STDERR join(" ", @platforms);
    }
    else {
	print STDERR "none.";
    }
    print STDERR "\n";
    exit 2;
}

do $platform_def;

push @new_args, @opts;

#
# documentation generation options
#
# get the directory above TOSDIR
my ($tosparent) = ($TOSDIR =~ m!^(.*)/.*?$!);
push @topdirs, $tosparent;

unshift @new_args, "-fnesc-include=tos";
unshift @new_args, map "-DBOARD_\U$_", @boards;
unshift @new_args, "-DPLATFORM_\U$target";
unshift @new_args, "nescc";

if (!$nostdinc) {
    push @new_args, map "-I$TOSDIR/sensorboards/$_", @boards;
    push @new_args, "-I$TOSDIR/platform/$target";
    push @new_args, map "-I$TOSDIR/platform/$_", @commonplatforms;
    push @new_args, "-I$TOSDIR/interfaces";
    push @new_args, "-I$TOSDIR/types";
    push @new_args, "-I$TOSDIR/system";
    push @new_args, "-I$TOSDIR/lib";
}

print STDERR join(' ', @new_args), "\n" if $verbose;
exec @new_args;
print STDERR "Couldn't execute ncc\n";
exit 2;

sub extractarg {
    local ($i) = @_;

    if (length($ARGV[$i]) == 2) {
	$arg = $ARGV[++$i];
    }
    else {
	$arg = substr($ARGV[$i], 2);
    }
    return ($i, $arg);
}

sub fail {
    print STDERR "$_[0]\n";
    exit 2;
}

